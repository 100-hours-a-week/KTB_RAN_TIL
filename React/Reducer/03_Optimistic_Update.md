### Optimistic Update

낙관적 업데이트

---

### 개념 요약

서버 응답을 기다리지 않고,
**“요청이 성공할 것이다”**라고 가정하고
UI를 먼저 업데이트하는 기법.

성공하면 그대로 유지하고,
실패하면 기존 상태로 되돌린다(rollback).

UI가 즉시 반응하기 때문에 사용자 경험이 매우 좋아진다.

---

### 왜 “낙관적”이라고 부르나?

대부분의 사용자는 액션을 수행했을 때
**성공할 가능성이 매우 높다**.

예를 들어 좋아요, 북마크, 장바구니 추가, 댓글 작성 등은
거의 항상 성공하기 때문에
“성공할 거라 낙관하며 UI를 먼저 갱신”하는 것.

---

### 기존 방식(비낙관적 업데이트)

```
1) 버튼 클릭
2) 서버 요청
3) 서버 응답 기다림
4) 성공하면 UI 업데이트
```

이 방식의 문제점:

* UI 반응 속도가 느림
* 클릭했는지 확신이 안 듦
* 로딩 스피너가 매번 뜨면 UX가 무거워짐

---

### 낙관적 업데이트 방식

```
1) 버튼 클릭
2) UI 먼저 업데이트
3) 서버 요청
4) 성공 → 그대로 유지
5) 실패 → 롤백(기존 값으로 복원)
```

장점:

* UI가 즉시 반응 → 체감 속도 매우 빠름
* 짧은 인터랙션(좋아요 등)에 최적화

---

### 예: 좋아요 기능

일반적인 흐름

```
클릭 → 서버 요청 → 응답 올 때까지 기다림 → UI 변경
```

낙관적 업데이트

```
클릭 → UI +1 즉시 반영 → 서버 요청 → 성공 시 확정
```

사용자 입장에서는 **바로 반응한다**고 느껴서 훨씬 부드럽다.

---

### React Query에서의 낙관적 업데이트

React Query는 낙관적 업데이트를 위한 패턴을 공식적으로 제공한다.
핵심은 `onMutate → onError → onSettled` 흐름.

```jsx
const mutation = useMutation({
  mutationFn: toggleLike,

  onMutate: async () => {
    const prev = queryClient.getQueryData(["post", id]);

    queryClient.setQueryData(["post", id], (old) => ({
      ...old,
      likeCount: old.likeCount + 1,
    }));

    return { prev };
  },

  onError: (err, variables, context) => {
    queryClient.setQueryData(["post", id], context.prev);
  },

  onSettled: () => {
    queryClient.invalidateQueries(["post", id]);
  }
});
```

설명:

* **onMutate**: UI 먼저 변경
* **onError**: 실패 시 롤백
* **onSettled**: 성공/실패 이후 서버 데이터와 동기화

이 방식은 서버 상태 관리가 필요한 경우 가장 많이 사용된다.

---

### 낙관적 업데이트가 필요한 이유

* UI 즉시 반응성
* 네트워크 지연을 느끼지 않게 함
* 사용자가 “눌렀다”는 피드백을 즉각적으로 확인 가능
* 짧은 액션(좋아요, 댓글 추가 등)에 최적화

---

### 실제로 사용되는 대표 상황들

| 기능                | 사용 여부 |
| ----------------- | ----- |
| 좋아요               | 거의 항상 |
| 북마크               | 자주    |
| 댓글 작성             | 많이 사용 |
| 장바구니 추가           | 매우 흔함 |
| 게시물 삭제            | 사용 가능 |
| 결제, 회원가입 등 중요한 작업 | 사용 X  |

계산이 중요한 작업, 실패하면 안 되는 작업은
낙관적 업데이트를 쓰지 않는다.

---

### 낙관적 업데이트의 핵심 구조

#### 1) 먼저 UI 변경

→ “사용자에게 즉시 반응성 제공”

#### 2) 서버 요청

→ 비동기 처리

#### 3) 실패 시 롤백

→ “원래 데이터”로 복원

#### 4) 성공 시 그대로 유지

→ UI와 서버 데이터가 합쳐짐

---

### 요약

* 낙관적 업데이트는 UI 경험을 빠르게 만들어주는 핵심 패턴
* 서버 응답 전에 UI를 먼저 바꿈
* 실패 시 롤백 필요
* React Query의 onMutate/onError/onSettled 패턴이 사실상 표준
* 좋아요, 북마크, 댓글 등 **즉시 반응이 필요한 기능**에 최적화
