### ì—”í‹°í‹° ìƒíƒœì™€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ê´€ê³„(ìƒëª…ì£¼ê¸°)

- **EntityManagerì˜ ê´€ë¦¬ ëŒ€ìƒì´ ë˜ëŠ”ê°€?**

### ì •ì˜

JPAê°€ ì—”í‹°í‹° ê°ì²´ë¥¼ ê´€ë¦¬í•˜ê³  ë™ì¼í•œ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ë³€ê²½ ì‚¬í•­ì„ ì¶”ì í•˜ê³  ìë™ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë™ê¸°í™” í•˜ëŠ” ë©”ëª¨ë¦¬ìƒì˜ ì €ì¥ì†Œ

**í‚¤ì›Œë“œ**

- **ì˜ì†ì„± : persistency**

  í”„ë¡œê·¸ë¨ì´ë‚˜ ì‹œìŠ¤í…œì´ ì¢…ë£Œë˜ì–´ë„ ë°ì´í„°ê°€ ê³„ì† ìœ ì§€ë˜ëŠ” ì„±ì§ˆ


---

### íŠ¹ì§•

- **ë©”ëª¨ë¦¬ ìƒì˜ ì €ì¥ì†Œ**
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•„ë‹ˆë¼ **ë©”ëª¨ë¦¬ì— ì¡´ì¬í•˜ëŠ” ë…¼ë¦¬ì  ê³µê°„**
    - JVM Heap ì•ˆì— ì¡´ì¬í•œë‹¤. (JPAëŠ” ê²°êµ­ ìë°” ê°ì²´ë¥¼ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸)
- **ì—”í‹°í‹°ì˜ ê´€ë¦¬**
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ëŠ” **JPAê°€ ê´€ë¦¬í•˜ëŠ” ì—”í‹°í‹° ê°ì²´**ë§Œ ë“¤ì–´ê°„ë‹¤.
    - ì¦‰, EntityManagerê°€ persist()ë¡œ ë“±ë¡í•œ ê°ì²´ë§Œ ê´€ë¦¬ëœë‹¤.
- **ë°ì´í„°ë² ì´ìŠ¤ì™€ ë™ê¸°í™”**
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë“¤ì–´ì˜¨ ì—”í‹°í‹°ë“¤ì˜ ë³€ê²½ì‚¬í•­ì„ ì¶”ì í•˜ê³ ,

      ì ì ˆí•œ ì‹œì ì— SQLì„ ìƒì„±í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜í•œë‹¤.

    - DB ë°˜ì˜ ì‹œì ì€ **flush ë‹¨ê³„**ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.

DBì— ìµœì¢…ìœ¼ë¡œ ì €ì¥ë˜ê¸° ì „ì—, ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì¤€ë¹„í•˜ëŠ” ì„ì‹œ ê³µê°„ì´ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**ë‹¤.

ì¦‰, ìµœì¢… ì‘ì„± ê³µê°„ = DB

ê·¸ ì „ì— ì‘ì„±í•˜ê³  ìˆ˜ì •í•˜ëŠ” ì„ì‹œ ì €ì¥ì†Œ = ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸

---

**ë¹„ìœ )**

- **ë¡œì»¬ ë ˆí¬ì§€í† ë¦¬ â†’ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**
- **ì›ê²© ë ˆí¬ì§€í† ë¦¬ â†’ ì‹¤ì œ DB**

  íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— push(=commit) ë˜ì–´ DBì— ë°˜ì˜ë¨.


> ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.
>
>
> EntityManagerë¥¼ í†µí•´ì„œë§Œ ê°„ì ‘ì ìœ¼ë¡œ ì ‘ê·¼í•œë‹¤.
>

ì¦‰, **EntityManagerëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë°ì´í„°**ë¥¼ ì˜¬ë¦¬ê³ , ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ì—­í• ì„ í•œë‹¤.

> **í•œ ì¤„ ì •ë¦¬**
>

<aside>
ğŸ’¡

**ì—”í‹°í‹° ë§¤ë‹ˆì €**ëŠ” ë©”ì„œë“œë¥¼ í†µí•´ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**ì™€ ì†Œí†µí•˜ë©´ì„œ ì—”í‹°í‹°ì˜ ìƒíƒœë¥¼ ë³€ê²½í•œë‹¤.

</aside>

---

### ë‹¨ì–´ ì •ë¦¬

- ORMì„ ìœ„í•´ì„œëŠ” DBì— ë§¤í•‘ë  ê°ì²´ê°€ í•„ìš”í•¨.

  â†’ **Entity**

- Entityë¥¼ ê´€ë¦¬í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” ê²ƒì´ **EntityManager**
- EntityManagerë¥¼ ìƒì„±í•˜ëŠ” ê²ƒì´ **EntityManagerFactory**
- Entityë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê³µê°„ì´ **Persistence Context**
- DB ì—°ê²° ì •ë³´(JDBC, URL ë“±)ë¥¼ ë‹´ì€ ë‹¨ìœ„ê°€ **Persistence Unit**

---

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ìƒëª…ì£¼ê¸° (ì—”í‹°í‹° ìƒíƒœ)

![image.png](attachment:385e5103-39ff-4271-803b-e3edf0f4c52f:image.png)

- **ë¹„ì˜ì† (Transient)**
    - new User() ê°ì²´ ìƒì„± â€” JPAì™€ ì•„ë¬´ ê´€ë ¨ ì—†ëŠ” **ìˆœìˆ˜ ìë°” ê°ì²´**
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì§€ ì•ŠìŒ.
- **ì˜ì† (Managed)**
    - EntityManager.persist(user)
    - ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ê´€ë¦¬í•˜ê¸° ì‹œì‘í•˜ë©°, **1ì°¨ ìºì‹œì— ì €ì¥**
    - ë³€ê²½ê°ì§€(Dirty Checking), ì“°ê¸°ì§€ì—°(Write-behind)ì˜ ëŒ€ìƒì´ ë¨
- **ì¤€ì˜ì† (Detached)**
    - ì˜ì† ìƒíƒœì˜€ë‹¤ê°€ EntityManager.close()ë‚˜ detach()ë¡œ **ê´€ë¦¬ì—ì„œ ì œì™¸ëœ ìƒíƒœ**
    - ë” ì´ìƒ ë³€ê²½ê°ì§€ë‚˜ flush ëŒ€ìƒì´ ì•„ë‹˜.
- **ì‚­ì œ (Removed)**
    - EntityManager.remove(user)
    - íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ DELETE SQL ì‹¤í–‰ë¨.

---

### ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì™œ ì•Œì•„ì•¼ í•˜ëŠ”ê°€?

1. **SQL ì‹¤í–‰ ì‹œì ì„ ì˜ˆì¸¡í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.**

   EntityManagerë‚˜ JpaRepositoryë¥¼ ì‚¬ìš©í•´ë„ ì¦‰ì‹œ DBì— ë°˜ì˜ë˜ì§€ ì•ŠëŠ”ë‹¤.

   (â†’ JDBCì™€ ë‹¬ë¦¬ JPAëŠ” SQLì„ ëª¨ì•˜ë‹¤ê°€ flush ì‹œì ì— ì‹¤í–‰í•œë‹¤.)

   ì¦‰, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” **JPAì˜ ì˜ì—­**ì´ë‹¤.

   JDBCëŠ” **ê·¸ í•˜ìœ„ ê³„ì¸µì—ì„œ ì‹¤ì œ SQLì„ ì „ì†¡í•˜ëŠ” ì—­í• **ë§Œ ë‹´ë‹¹í•œë‹¤.

2. **ì—”í‹°í‹°ì˜ ìƒíƒœ ë³€í™”ë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ì„œ**

   ì˜ì†, ì¤€ì˜ì†, ì‚­ì œ ìƒíƒœë¥¼ ì •í™•íˆ ì´í•´í•´ì•¼ í•œë‹¤.

   ê·¸ë˜ì•¼ "ë¶„ëª…íˆ ê°’ì„ ë°”ê¿¨ëŠ”ë° DBì—ëŠ” ì•ˆë°”ë€œ" ê°™ì€ ë¬¸ì œë¥¼ í”¼í•  ìˆ˜ ìˆë‹¤.

3. **ì„±ëŠ¥ ìµœì í™”**
    - 1ì°¨ ìºì‹œë¡œ DB ì ‘ê·¼ ìµœì†Œí™”
    - ë™ì¼ì„± ë³´ì¥ìœ¼ë¡œ ê°™ì€ ê°ì²´ ì¬ì‚¬ìš©
    - ì“°ê¸°ì§€ì—°ìœ¼ë¡œ ë„¤íŠ¸ì›Œí¬ I/O ìµœì†Œí™”

      â†’ ì‹¤ë¬´ì—ì„œ â€œì„±ëŠ¥ ê°œì„ â€ ê·¼ê±°ë¡œ ìì£¼ ë“±ì¥í•¨.


---

### 1ì°¨ ìºì‹œ

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë‚´ë¶€ì— ì¡´ì¬í•˜ë©°, key = PK / value = ì—”í‹°í‹° ê°ì²´ í˜•íƒœë¡œ ì €ì¥ëœë‹¤.
- ê°™ì€ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ `em.find(User.class, 1L)` ì„ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•´ë„ DB ì ‘ê·¼ì€ í•œ ë²ˆë§Œ ì¼ì–´ë‚¨.
- DBì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ì „, ë¨¼ì € 1ì°¨ ìºì‹œì—ì„œ ì¡°íšŒí•œë‹¤.

> EntityManagerëŠ” 1ì°¨ ìºì‹œë¥¼ ê´€ë¦¬í•˜ë©´ì„œ,
>
>
> ì—†ì„ ê²½ìš°ì—ë§Œ JDBCë¥¼ í†µí•´ DBì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
>

![image.png](attachment:9bd6fd7e-54b4-476a-bc85-18c7ee00499f:image.png)

### ì“°ê¸° ì§€ì—° (Write-behind)

- ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ë„¤íŠ¸ì›Œí¬ í†µì‹  ë¹„ìš©ì€ ë¹„ì‹¸ë‹¤.
- JPAëŠ” SQLì„ ì¦‰ì‹œ ë³´ë‚´ì§€ ì•Šê³ , **ì“°ê¸° ì§€ì—° SQL ì €ì¥ì†Œ**ì— ëª¨ì•„ë‘ì—ˆë‹¤ê°€

  flush ì‹œì ì— í•œ ë²ˆì— DBë¡œ ë³´ë‚¸ë‹¤.

- **flush ì‹œì **
    - íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ
    - JPQL ì‹¤í–‰ ì‹œ
    - `em.flush()` ì§ì ‘ í˜¸ì¶œ ì‹œ

![image.png](attachment:26f79bd4-bf16-409e-984b-5739d2472410:image.png)

---

ë³€ê²½ê°ì§€

- **Dirty-checkë¼ê³  í•˜ëŠ” ì´ìœ **
    - Dirty : ë°ì´í„°ê°€ ì›ë³¸ ìƒíƒœì—ì„œ ìˆ˜ì •ë˜ì—ˆìŒ.
- **ì—”í‹°í‹°ê°€ ì˜ì»¨ì— ì²˜ìŒ ë“¤ì–´ì˜¬ ë•Œ ê³¼ì •**
    1. ì—”í‹°í‹°ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì²˜ìŒ ì˜ì†ë  ë•Œ ê·¸ ìƒíƒœ**(ì—”í‹°í‹° ìƒíƒœ)** ê·¸ëŒ€ë¡œ ìŠ¤ëƒ…ìƒ·ì„ í•˜ë‚˜ ë³µì‚¬í•´ì„œ ë³´ê´€í•´ë‘”ë‹¤.**[v1]**
    2. ê°œë°œìê°€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ììœ ë¡­ê²Œ **ì—”í‹°í‹°ì˜ ê°’ì„ ë³€ê²½**í•œë‹¤.**[v2]**
    3. íŠ¸ëœì­ì…˜ ì»¤ë°‹ë˜ëŠ” ì‹œì ì— **JPAëŠ” 1ì°¨ ìºì‹œì— ìˆëŠ” í˜„ì¬ ì—”í‹°í‹°ì™€ 1ë²ˆì—ì„œ ì°ì–´ë‘” ìŠ¤ëƒ…ìƒ· ë¹„êµâ‡’**
        1. **v1 == v2 :** ì´í›„ ë™ì‘ ì—†ì´ ë
        2. **v1 â‰  v2 :** UPDATE SQL ì‹¤í–‰

![image.png](attachment:09a48483-e926-450c-91cb-422d5484e8f6:image.png)

ë”í‹° ì²´í¬ëŠ” ì“°ê¸° ì§€ì—°(Write-behind)ì— ë“¤ì–´ê°ˆ UPDATE SQLì„ ì„ ë³„í•˜ê³  ìƒì„±í•˜ëŠ” ë‹¨ê³„ì´ê³ , ê·¸ ê²°ê³¼ ìƒì„±ëœ SQL(INSERT, UPDATE, DELETE ë“±)ì€ **flush ì‹œì ì— í•œêº¼ë²ˆì— ì‹¤í–‰** ë©ë‹ˆë‹¤.

---

**flushì™€ commit ì°¨ì´ì **

- **flush**
    - SQLì„ DBë¡œ ë³´ë‚¸ë‹¤ (ì‹¤í–‰ë§Œ í•¨)
    - DBì˜ ë²„í¼ í’€ì— ë°˜ì˜ë¨ (ì•„ì§ ë””ìŠ¤í¬ì—ëŠ” X)
- **commit**
    - DB ë‚´ë¶€ì—ì„œ íŠ¸ëœì­ì…˜ì„ í™•ì • (ë²„í¼í’€ â†’ ë””ìŠ¤í¬ ì €ì¥)
    - ì‹¤ì œ **ë°ì´í„°ì˜ ì˜êµ¬ ë°˜ì˜ ë‹¨ê³„**

JPAëŠ” flush í›„ JDBCë¥¼ í†µí•´ DBì— ëª…ë ¹ì„ ì „ì†¡í•˜ê³ ,

DBëŠ” ìì²´ ë²„í¼ í’€ì„ ê±°ì³ commit/checkpoint ê³¼ì •ì„ í†µí•´

ë””ìŠ¤í¬ì— ìµœì¢… ì €ì¥í•œë‹¤.

> ì¦‰, â€œflush = DBì— ë³´ë‚´ê¸°â€, â€œcommit = ë””ìŠ¤í¬ì— í™•ì •â€
>
>
> JPA â†’ JDBC â†’ DB Buffer Pool â†’ Disk ìˆœì„œ
>
- **JPA (EntityManager, Persistence Context)**

  ë©”ëª¨ë¦¬ ë‚´ë¶€ì—ì„œ ì—”í‹°í‹° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê³  SQL ìƒì„±

- **JDBC**

  JPAê°€ ìƒì„±í•œ SQLì„ DBì— ì „ë‹¬í•˜ëŠ” **í‘œì¤€ í†µì‹  API**

- **DB(Buffer Pool â†’ Disk)**

  ì‹¤ì œ ë°ì´í„° ì €ì¥ì†Œ


```
JPA (Persistence Context - EntityManager)
    â†“
JDBC (SQL ì „ë‹¬)
    â†“
DB Buffer Pool
    â†“
DB Disk
```

### ì •ë¦¬ : JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ êµ¬ì¡°

![Untitled diagram-2025-10-28-070100.png](attachment:ffdef834-5e73-4b67-9ba3-0188278cf7c8:Untitled_diagram-2025-10-28-070100.png)